#!/bin/bash
set -e

# Base paths
WORKDIR=/home/jade/1_sandsmelt/rundrap/out_drap_s1
TXDIR=$WORKDIR/meta_BR/d-cov_filter

# Transcriptomes
TX0=$TXDIR/transcripts_fpkm_0.fa
TX1=$TXDIR/transcripts_fpkm_1.fa

# Index directories
IDX0=$WORKDIR/salmon_index_fpkm0
IDX1=$WORKDIR/salmon_index_fpkm1

# Build Salmon indices (once per transcriptome)
salmon index --index $IDX0 --transcripts $TX0
salmon index --index $IDX1 --transcripts $TX1

# Sample directories (all B and R folders)
SAMPLES="2B 2R 5B 5R 6B 6R 7B 7R 8B 8R 9B 9R 10B 10R \
         11B 11R 12B 12R 13B 13R 14B 14R 16B 16R 17B 17R 18B 18R"

# Run Salmon quant for each sample and transcriptome
for S in $SAMPLES; do
    R1=$WORKDIR/$S/uf${S}_1.norm.fq.gz
    R2=$WORKDIR/$S/uf${S}_2.norm.fq.gz

    # Output directories
    OUT0=$WORKDIR/${S}_quant_fpkm0
    OUT1=$WORKDIR/${S}_quant_fpkm1

    echo "Running Salmon for sample $S on fpkm=0 transcriptome..."
    salmon quant --index $IDX0 --libType A \
        --dumpEq --hardFilter --skipQuant \
        -1 $R1 -2 $R2 \
        --output $OUT0

    echo "Running Salmon for sample $S on fpkm=1 transcriptome..."
    salmon quant --index $IDX1 --libType A \
        --dumpEq --hardFilter --skipQuant \
        -1 $R1 -2 $R2 \
        --output $OUT1

    # Unzip eq_classes.txt.gz
    gunzip -c $OUT0/aux_info/eq_classes.txt.gz > $OUT0/aux_info/eq_classes.txt
    gunzip -c $OUT1/aux_info/eq_classes.txt.gz > $OUT1/aux_info/eq_classes.txt
done

###Corset###

# Base working directory
WORKDIR="/home/jade/1_sandsmelt/rundrap/out_drap_s1"

# Samples (order will be used in -n and -g)
SAMPLES="2B 2R 5B 5R 6B 6R 7B 7R 8B 8R 9B 9R 10B 10R 11B 11R 12B 12R 13B 13R 14B 14R 16B 16R 17B 17R 18B 18R"

# Destination folders (one per fpkm value)
EQDIR0="$WORKDIR/corset_eq_fpkm0"
EQDIR1="$WORKDIR/corset_eq_fpkm1"
mkdir -p "$EQDIR0" "$EQDIR1"

# 1) Copy eq_classes.txt into sample-named subfolders, keeping the original filename
for S in $SAMPLES; do
    src0="$WORKDIR/${S}_quant_fpkm0/aux_info/eq_classes.txt"
    src1="$WORKDIR/${S}_quant_fpkm1/aux_info/eq_classes.txt"

    [[ -s "$src0" ]] || { echo "Missing: $src0" >&2; exit 1; }
    [[ -s "$src1" ]] || { echo "Missing: $src1" >&2; exit 1; }

    mkdir -p "$EQDIR0/$S" "$EQDIR1/$S"
    cp -f "$src0" "$EQDIR0/$S/eq_classes.txt"
    cp -f "$src1" "$EQDIR1/$S/eq_classes.txt"
done

# 2) Run Corset with hardcoded -n and -g, using filenames directly via glob
# Grouping: 2,5,6,7,8,9,10 -> lone_fish; 11,12,13,14,16,17,18 -> school
# -n and -g are comma-separated lists matching the sample order above

echo "Running Corset on fpkm=0 transcriptome..."
corset -i salmon_eq_classes -p corset_fpkm0 \
  -n "2B,2R,5B,5R,6B,6R,7B,7R,8B,8R,9B,9R,10B,10R,11B,11R,12B,12R,13B,13R,14B,14R,16B,16R,17B,17R,18B,18R" \
  -g "lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,school,school,school,school,school,school,school,school,school,school,school,school,school,school" \
  "$EQDIR0"/*/eq_classes.txt

echo "Running Corset on fpkm=1 transcriptome..."
corset -i salmon_eq_classes -p corset_fpkm1 \
  -n "2B,2R,5B,5R,6B,6R,7B,7R,8B,8R,9B,9R,10B,10R,11B,11R,12B,12R,13B,13R,14B,14R,16B,16R,17B,17R,18B,18R" \
  -g "lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,lone_fish,school,school,school,school,school,school,school,school,school,school,school,school,school,school" \
  "$EQDIR1"/*/eq_classes.txt

echo "Done."


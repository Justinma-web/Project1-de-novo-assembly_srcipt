#!/bin/bash

###Check contigs###
grep -o ">" <filename.fa> | wc -l

###‘TrinityStats.pl’ from Trinity accessory scripts: basic stats###
##https://github.com/trinityrnaseq/trinityrnaseq/tree/master/util##
##perl <TrinityStats.pl's path> [transcriptome]###
perl /home/jade/3_trinityrnaseq-v2.15.1/util/TrinityStats.pl transcripts_fpkm_0.fa

###Stats.sh from bbmap: basic stats###
/home/jade/anaconda3/bin/stats.sh in=transcripts.fa

###BUSCO: check biological meanings###


### Bowtie2: check mapping rate, save as script###
#!/bin/bash
set -euo pipefail

### Bowtie2: check mapping rate ###

# Base directory for Bowtie2 indexes
INDEX_BASE=/home/jade/1_sandsmelt/rundrap/bowtie2_indexes
mkdir -p "$INDEX_BASE"

# Output base directory for SAM files and logs
MAP_BASE=/home/jade/1_sandsmelt/rundrap/mapping_results
mkdir -p "$MAP_BASE"

# Directory containing your read files
READS_DIR=/home/jade/1_sandsmelt/rundrap/out_drap_s1

# Transcriptome FASTA files (Strategies 1–3)
TRANSCRIPTOMES=(
  "/home/jade/1_sandsmelt/rundrap/out_drap_s1/meta_BR/d-cov_filter/cluster_0_s1_group.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s1/meta_BR/d-cov_filter/cluster_1_s1_group.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s1/meta_BR/d-cov_filter/cluster_0_s1_nogroup.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s1/meta_BR/d-cov_filter/cluster_1_s1_nogroup.fa"

  "/home/jade/1_sandsmelt/rundrap/out_drap_s2/transcripts_fpkm_0.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s2/transcripts_fpkm_0.5.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s2/cluster_0_s2.fa"
  "/home/jade/1_sandsmelt/rundrap/out_drap_s2/cluster_0.5_s2.fa"

  "/home/jade/1_sandsmelt/rundrap/meta_s3/transcripts_fpkm_0.fa"
  "/home/jade/1_sandsmelt/rundrap/meta_s3/transcripts_fpkm_0.5.fa"
  "/home/jade/1_sandsmelt/rundrap/meta_s3/transcripts_fpkm_1.fa"
  "/home/jade/1_sandsmelt/rundrap/meta_s3/cluster_0_s3.fa"
  "/home/jade/1_sandsmelt/rundrap/meta_s3/cluster_0.5_s3.fa"
)

### Build Bowtie2 indexes ###
for FASTA in "${TRANSCRIPTOMES[@]}"; do
    NAME=$(basename "$FASTA" .fa)   # e.g. cluster_0_s1_group
    IDX_DIR="$INDEX_BASE/$NAME"
    mkdir -p "$IDX_DIR"

    echo "=== Building Bowtie2 index for $NAME ==="
    bowtie2-build "$FASTA" "$IDX_DIR/$NAME"
done

echo "=== All requested indexes built successfully ==="

### Mapping ###
for FASTA in "${TRANSCRIPTOMES[@]}"; do
    NAME=$(basename "$FASTA" .fa)
    IDX_DIR="$INDEX_BASE/$NAME"
    OUTDIR="$MAP_BASE/$NAME"
    mkdir -p "$OUTDIR"

    echo "=== Mapping reads to $NAME ==="

    # Loop through all forward read files (_1.norm.fq.gz)
    for R1 in "$READS_DIR"/*/uf*_1.norm.fq.gz; do
        R2=${R1/_1.norm.fq.gz/_2.norm.fq.gz}
        SAMPLE_DIR=$(basename "$(dirname "$R1")")
        SAMPLE=$(basename "$R1" _1.norm.fq.gz)

        echo "Mapping $SAMPLE_DIR ($SAMPLE) to $NAME..."

        bowtie2 -x "$IDX_DIR/$NAME" \
            -1 "$R1" \
            -2 "$R2" \
            -q -p 22 --sensitive --no-discordant --no-mixed \
            -S "$OUTDIR/${SAMPLE_DIR}_${SAMPLE}.sam" \
            2> "$OUTDIR/${SAMPLE_DIR}_${SAMPLE}_bowtie2.txt"

        echo "Finished mapping $SAMPLE_DIR ($SAMPLE) to $NAME"
        echo "----------------------------------------"
    done
done

echo "=== All mappings completed ==="


